{"ast":null,"code":"import 'reflect-metadata';\nimport { ApolloServer } from 'apollo-server-micro';\nimport { createSchema } from 'graphql/schema';\nimport { createConnection, getConnectionManager } from 'typeorm';\nimport dotenv from 'dotenv';\nimport { ShirtEntity } from 'db/entity/ShirtEntity';\nimport { ProductEntity } from 'db/entity/ProductEntity';\nimport { PantsEntity } from 'db/entity/PantsEntity';\ndotenv.config();\nlet apolloServer; // eslint-disable-next-line\n\nlet apolloHandler;\nlet connection;\nexport const config = {\n  api: {\n    bodyParser: false\n  }\n};\nexport default (async (req, res) => {\n  if (!apolloServer) {\n    const schema = await createSchema();\n    apolloServer = new ApolloServer({\n      schema\n    });\n    apolloHandler = apolloServer.createHandler({\n      path: '/api/graphql'\n    });\n  }\n\n  if (!connection) {\n    const initConnection = async () => await createConnection({\n      type: 'mysql',\n      host: process.env.DB_HOST,\n      port: parseInt(process.env.DB_PORT),\n      username: process.env.DB_USER,\n      password: process.env.DB_PASSWORD,\n      database: process.env.DB_DATABASE,\n      entities: [ProductEntity, ShirtEntity, PantsEntity]\n    });\n\n    try {\n      connection = await initConnection();\n    } catch (e) {\n      if (e.name === 'AlreadyHasActiveConnectionError') {\n        connection = getConnectionManager().get('default');\n        await connection.close();\n        connection = await initConnection();\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  return await apolloHandler(req, res);\n});","map":{"version":3,"sources":["/Users/aleksey/Dev/Trash/shopping-cart/pages/api/graphql.ts"],"names":["ApolloServer","createSchema","createConnection","getConnectionManager","dotenv","ShirtEntity","ProductEntity","PantsEntity","config","apolloServer","apolloHandler","connection","api","bodyParser","req","res","schema","createHandler","path","initConnection","type","host","process","env","DB_HOST","port","parseInt","DB_PORT","username","DB_USER","password","DB_PASSWORD","database","DB_DATABASE","entities","e","name","get","close"],"mappings":"AAAA,OAAO,kBAAP;AACA,SAASA,YAAT,QAA6B,qBAA7B;AAEA,SAASC,YAAT,QAA6B,gBAA7B;AACA,SAAqBC,gBAArB,EAAuCC,oBAAvC,QAAmE,SAAnE;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,SAASC,WAAT,QAA4B,uBAA5B;AACA,SAASC,aAAT,QAA8B,yBAA9B;AACA,SAASC,WAAT,QAA4B,uBAA5B;AACAH,MAAM,CAACI,MAAP;AAEA,IAAIC,YAAJ,C,CAEA;;AACA,IAAIC,aAAJ;AAEA,IAAIC,UAAJ;AAEA,OAAO,MAAMH,MAAM,GAAG;AACpBI,EAAAA,GAAG,EAAE;AACHC,IAAAA,UAAU,EAAE;AADT;AADe,CAAf;AAMP,gBAAe,OAAOC,GAAP,EAA4BC,GAA5B,KAAoE;AACjF,MAAI,CAACN,YAAL,EAAmB;AACjB,UAAMO,MAAM,GAAG,MAAMf,YAAY,EAAjC;AACAQ,IAAAA,YAAY,GAAG,IAAIT,YAAJ,CAAiB;AAAEgB,MAAAA;AAAF,KAAjB,CAAf;AACAN,IAAAA,aAAa,GAAGD,YAAY,CAACQ,aAAb,CAA2B;AAAEC,MAAAA,IAAI,EAAE;AAAR,KAA3B,CAAhB;AACD;;AACD,MAAI,CAACP,UAAL,EAAiB;AACf,UAAMQ,cAAc,GAAG,YACrB,MAAMjB,gBAAgB,CAAC;AACrBkB,MAAAA,IAAI,EAAE,OADe;AAErBC,MAAAA,IAAI,EAAEC,OAAO,CAACC,GAAR,CAAYC,OAFG;AAGrBC,MAAAA,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAR,CAAYI,OAAb,CAHO;AAIrBC,MAAAA,QAAQ,EAAEN,OAAO,CAACC,GAAR,CAAYM,OAJD;AAKrBC,MAAAA,QAAQ,EAAER,OAAO,CAACC,GAAR,CAAYQ,WALD;AAMrBC,MAAAA,QAAQ,EAAEV,OAAO,CAACC,GAAR,CAAYU,WAND;AAOrBC,MAAAA,QAAQ,EAAE,CAAC5B,aAAD,EAAgBD,WAAhB,EAA6BE,WAA7B;AAPW,KAAD,CADxB;;AAUA,QAAI;AACFI,MAAAA,UAAU,GAAG,MAAMQ,cAAc,EAAjC;AACD,KAFD,CAEE,OAAOgB,CAAP,EAAU;AACV,UAAIA,CAAC,CAACC,IAAF,KAAW,iCAAf,EAAkD;AAChDzB,QAAAA,UAAU,GAAGR,oBAAoB,GAAGkC,GAAvB,CAA2B,SAA3B,CAAb;AACA,cAAM1B,UAAU,CAAC2B,KAAX,EAAN;AACA3B,QAAAA,UAAU,GAAG,MAAMQ,cAAc,EAAjC;AACD,OAJD,MAIO;AACL,cAAMgB,CAAN;AACD;AACF;AACF;;AACD,SAAO,MAAMzB,aAAa,CAACI,GAAD,EAAMC,GAAN,CAA1B;AACD,CA9BD","sourcesContent":["import 'reflect-metadata';\nimport { ApolloServer } from 'apollo-server-micro';\nimport { NextApiRequest, NextApiResponse } from 'next';\nimport { createSchema } from 'graphql/schema';\nimport { Connection, createConnection, getConnectionManager } from 'typeorm';\nimport dotenv from 'dotenv';\nimport { ShirtEntity } from 'db/entity/ShirtEntity';\nimport { ProductEntity } from 'db/entity/ProductEntity';\nimport { PantsEntity } from 'db/entity/PantsEntity';\ndotenv.config();\n\nlet apolloServer: ApolloServer;\n\n// eslint-disable-next-line\nlet apolloHandler: (req: any, res: any) => Promise<void>;\n\nlet connection: Connection;\n\nexport const config = {\n  api: {\n    bodyParser: false,\n  },\n};\n\nexport default async (req: NextApiRequest, res: NextApiResponse): Promise<void> => {\n  if (!apolloServer) {\n    const schema = await createSchema();\n    apolloServer = new ApolloServer({ schema });\n    apolloHandler = apolloServer.createHandler({ path: '/api/graphql' });\n  }\n  if (!connection) {\n    const initConnection = async () =>\n      await createConnection({\n        type: 'mysql',\n        host: process.env.DB_HOST,\n        port: parseInt(process.env.DB_PORT),\n        username: process.env.DB_USER,\n        password: process.env.DB_PASSWORD,\n        database: process.env.DB_DATABASE,\n        entities: [ProductEntity, ShirtEntity, PantsEntity],\n      });\n    try {\n      connection = await initConnection();\n    } catch (e) {\n      if (e.name === 'AlreadyHasActiveConnectionError') {\n        connection = getConnectionManager().get('default');\n        await connection.close();\n        connection = await initConnection();\n      } else {\n        throw e;\n      }\n    }\n  }\n  return await apolloHandler(req, res);\n};\n"]},"metadata":{},"sourceType":"module"}